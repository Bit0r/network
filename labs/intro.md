人们对网络协议的理解往往可以通过“看到协议的作用”和“玩协议”来大大加深——观察两个协议实体之间交换的消息序列，深入研究协议操作的细节，并使协议执行某些操作，然后观察这些操作及其后果。这可以在模拟场景中完成，也可以在“真实”的网络环境（如Internet）中完成。在本课程中你将要学习的Wireshark实验室中，你将使用自己的计算机在不同的场景中运行各种网络应用程序。您将观察计算机中的网络协议“正在运行”，与Internet中其他地方执行的协议实体进行交互和交换消息。因此，你和你的电脑将是这些“现场”实验室不可或缺的一部分。你会观察，也会通过实践来学习。

在第一个Wireshark实验室中，您将熟悉Wireshark，并进行一些简单的包捕获和观察。

观察执行协议实体之间交换的消息的基本工具称为**包嗅探器**。顾名思义，包嗅探器捕获（“嗅探”）从您的计算机发送/接收的消息；它通常还将在这些捕获的消息中存储和/或显示各种协议字段的内容。包嗅探器本身是被动的。它观察运行在计算机上的应用程序和协议发送和接收的消息，但从不发送数据包本身。类似地，接收到的数据包永远不会显式地寻址到包嗅探器。相反，包嗅探器接收从计算机上执行的应用程序和协议发送/接收的数据包的*副本*。

图1显示了包嗅探器的结构。在图1的右侧是通常在您的计算机上运行的协议（在本例中是Internet协议）和应用程序（如web浏览器或电子邮件客户端）。包嗅探器，如图1中的虚线矩形所示，是对计算机中常用软件的补充，它由两部分组成。**包捕获库**接收通过给定接口（链路层，如以太网或WiFi）从计算机发送或接收的每个链路层帧的副本。回想一下文本（图1.24）第1.5节的讨论，由更高层协议（如HTTP、FTP、TCP、UDP、DNS或IP）交换的消息最终都封装在链路层帧中，这些帧通过物理媒体（如以太网电缆或802.11 WiFi无线电）传输。因此，捕获所有链路层帧，就可以从计算机中执行的所有协议和应用程序通过监视的链路发送/接收的所有消息。

---

![](media/intro/image1.png)
**图1**：包嗅探器结构

---

包嗅探器的第二个组件是**包分析器**，它显示协议消息中所有字段的内容。为了做到这一点，包分析器必须“理解”协议交换的所有消息的结构。例如，假设我们有兴趣显示图1中HTTP协议交换的消息中的各个字段。包分析器理解以太网帧的格式，因此可以识别以太网帧中的IP数据报。它还理解IP数据报格式，以便能够提取IP数据报中的TCP段。最后，它了解TCP段的结构，因此可以提取TCP段中包含的HTTP消息。最后，它了解HTTP协议，因此，例如，它知道HTTP消息的第一个字节将包含字符串“GET”、“POST”或“HEAD”，如文本中的图2.8所示。

对于这些实验我们将使用[Wireshark](http://www.wireshark.org/)包嗅探器，允许我们显示协议栈不同级别的协议发送/接收的消息的内容。（从技术上讲，Wireshark是一种数据包分析器，它使用计算机中的数据包捕获库。另外，从技术上讲，Wireshark捕获了如图1所示的链路层帧，但使用了通用术语“包”来指代链路层帧、网络层数据报、传输层段和应用层消息，因此我们将使用此处不太精确的“包”术语来配合Wireshark约定）。Wireshark是一个免费的网络协议分析器，运行在Windows、Mac和Linux/Unix计算机上。对于我们的实验室来说，它是一个理想的数据包分析器—它稳定，有大量的用户基础和包括用户指南在内的文档支持(<http://www.wireshark.org/docs/wsug_html_chunked/>)，手册页(<http://www.wireshark.org/docs/man-pages/>)，以及详细的常见问题解答(<http://www.wireshark.org/faq.html>), 丰富的功能，包括分析数百个协议的能力，以及设计良好的用户界面。它在使用以太网、串行（PPP）、802.11（WiFi）无线局域网和许多其他链路层技术的计算机上运行。

## 安装Wireshark

为了运行Wireshark，您需要访问同时支持Wireshark和*libpcap*或*WinPCap*包捕获库的计算机。安装Wireshark时，如果操作系统中未安装*libpcap*软件，则会为您安装。在<http://www.wireshark.org/download.html>可以获取支持的操作系统和下载站点的列表。

下载并安装Wireshark软件：

* 转到<http://www.wireshark.org/download.html>下载并安装你电脑的Wireshark二进制文件。

Wireshark的FAQ有许多有用的提示和有趣的信息，特别是当您在安装或运行Wireshark时遇到困难时。

## 运行Wireshark

当你运行Wireshark程序时，你会看到一个类似下面屏幕的启动屏幕。不同版本的Wireshark会有不同的启动屏幕-所以如果你的屏幕看起来不像下面的屏幕，请不要惊慌！Wireshark文档指出：“由于Wireshark运行在许多不同的平台上，有许多不同的窗口管理器，应用了不同的样式，并且使用了不同版本的底层GUI工具箱，所以您的屏幕看起来可能与提供的屏幕截图不同。但由于在功能上没有真正的区别，这些截图还是可以理解的。

---

![](media/intro/image2.png)
**图2**：初始Wireshark屏幕

---

这个屏幕上没有多少有趣的东西。但请注意，在Capture部分下，有一个所谓接口的列表。我们拍摄这些截图的Mac电脑只有一个接口——`Wi-Fi: en0`（图2中用蓝色阴影表示），这是Wi-Fi接入的接口。所有来自这台计算机的数据包都将通过Wi-Fi接口，因此我们要在这里捕获数据包。在Mac上，双击此接口（或在另一台计算机上，在启动页面上找到连接Internet的接口，例如，很可能是WiFi或以太网接口，然后选择该接口）。

我们带着Wireshark出去转转吧！如果您单击其中一个接口以开始数据包捕获（即，Wireshark开始捕获发送到/来自该接口的所有数据包），将显示一个类似于下面的屏幕，显示有关正在捕获的数据包的信息。一旦启动了包捕获，就可以使用capture下拉菜单并选择停止（或者单击图2中Wireshark图标旁边的红色方块按钮）来停止它。

---

![](media/intro/image3.png)

**图3**：Wireshark窗口，捕获期间和之后

---

这看起来更有趣！Wireshark接口有五个主要组件：

* **命令菜单**是标准的下拉菜单，位于Wireshark窗口的顶部（在Mac上也在屏幕顶部；图3中的屏幕截图来自Mac）。我们现在感兴趣的是文件和捕获菜单。“文件”菜单允许您保存捕获的数据包数据，或打开包含以前捕获的数据包数据的文件并退出Wireshark应用程序。捕获菜单允许您开始数据包捕获。

* **包列表窗口**显示捕获的每个数据包的单行摘要，包括数据包编号（由Wireshark分配；请注意，这**不是**任何协议标头中包含的数据包编号）、数据包被捕获的时间、包的源地址和目标地址、协议类型，以及包中包含的协议特定信息。通过单击列名，可以根据这些类别中的任何一个对数据包列表进行排序。协议类型字段列出发送或接收此数据包的最高级别协议，即作为该数据包的源或最终接收器的协议。

* **包头详细信息窗口**提供了在数据包列表窗口中选择（突出显示）的数据包的详细信息。（要在数据包列表窗口中选择数据包，请将光标放在数据包列表窗口中该数据包的单行摘要上，然后用鼠标左键单击。）。这些详细信息包括有关以太网帧的信息（假设数据包是通过以太网接口发送/接收的）和包含该数据包的IP数据报。通过单击“数据包详细信息”窗口中以太网帧或IP数据报行左侧的加号/减号框或右/下三角形，可以展开或最小化显示的以太网和IP层详细信息量。如果数据包是通过TCP或UDP传输的，则还会显示TCP或UDP的详细信息，这些信息同样可以展开或最小化。最后，还提供了发送或接收该包的最高级别协议的详细信息。

* **数据包内容窗口**以ASCII和十六进制格式显示捕获帧的全部内容。

* Wireshark图形用户界面的顶部是**数据包显示筛选器区**，可以在其中输入协议名称或其他信息，以便过滤数据包列表窗口（以及数据包标题和数据包内容窗口）中显示的信息。在下面的示例中，我们将使用数据包显示筛选器来隐藏（不显示）Wireshark数据包，除了那些对应于HTTP消息的包。

## 带着Wireshark进行测试

学习任何新软件的最好方法就是试用它！我们假设您的计算机通过有线以太网接口或无线802.11 WiFi接口连接到Internet。执行以下操作：

1. 启动您最喜欢的web浏览器，它将显示您选择的主页。

2. 启动Wireshark软件。您将首先看到一个类似于图2所示的窗口。Wireshark还没有开始捕获数据包。

3. 要开始数据包捕获，请选择“捕获”下拉菜单并选择*接口*。这将导致显示“Wireshark:捕获接口”窗口（在PC上），或者您可以在Mac上选择选项。您应该看到一个接口列表，如图4a（Windows）和4b（Mac）所示。

---

![](media/intro/image4.png)

**图4a:** Wireshark捕获界面窗口，在Windows计算机上

![](media/intro/image5.png)

**图4b:** Wireshark捕获界面窗口，在Mac计算机上

---

4. 您将看到计算机上接口的列表以及到目前为止在该接口上观察到的数据包的计数。在一台Windows机器上，单击*开始*找到您想要开始包捕获的接口（在图4a中，是千兆网络连接）。在Windows计算机上，选择界面并单击窗口底部的“开始”）。数据包捕获现在开始Wireshark正在捕获从您的计算机发送/接收的所有数据包！

5. 一旦开始包捕获，就会出现一个类似于图3所示的窗口。此窗口显示正在捕获的数据包。通过选择*捕获*下拉菜单并选择*停止*，或单击红色停止方块，您可以停止数据包捕获。但现在不要停止包捕获。让我们先捕获一些有趣的包。为此，我们需要生成一些网络流量。让我们用一个web浏览器来实现，它将使用我们将在课堂上详细学习的HTTP协议来从网站下载内容。

6. 当Wireshark运行时，输入URL:<http://gaia.cs.umass.edu/wireshark-labs/INTRO-wireshark-file1.html>并在浏览器中显示该页面。为了显示此页面，您的浏览器与`gaia.cs.umass.edu`的HTTP服务器连接并与服务器交换HTTP消息，以便下载此页面，如本文第2.2节所述。包含这些HTTP消息的以太网或WiFi帧（以及通过以太网或WiFi适配器的所有其他帧）将被Wireshark捕获。

7. 在您的浏览器显示`INTRO-wireshark-file1.html`页面（这是一行简单的祝贺语）之后，通过在wireshark捕获窗口中选择*停止*来停止wireshark包捕获。Wireshark主窗口现在应该类似于图3。您现在有了包含您的计算机和其他网络实体之间交换的所有协议消息的实时数据包数据！HTTP消息与`gaia.cs.umass.edu` web服务器应出现在捕获的数据包列表中的某个位置。但也会显示许多其他类型的数据包（例如，请参见图3中*协议*列中显示的许多不同协议类型）。即使你所采取的唯一行动是下载网页，显然还有许多其他协议在你的电脑上运行，用户看不见。我们将在阅读课文的过程中进一步了解这些协议！现在，你应该意识到，事物往往远不止“表面现象”！

8. 在Wireshark主窗口顶部的显示过滤器窗口中输入`http`（不带引号，并为**小写**——所有协议名称在Wireshark中都是小写）。然后选择*应用*（在您输入“http”的右边），或者点击返回。这将导致只在数据包列表窗口中显示HTTP消息。下面的图5显示了将http过滤器应用于图3前面所示的包捕获窗口之后的屏幕截图。还请注意，在所选包详情窗口中，我们选择显示在TCP段中发现的超文本传输协议应用程序消息的详细内容，该消息位于Ethernet II（WiFi）帧内的IPv4数据报中。聚焦特定消息、段、数据报和帧级别的内容可以让我们只关注我们想要看的内容（在本例中是HTTP消息）。


---

![](media/intro/image6.png)
**图5**：查看包含HTTP `GET`消息的详细信息<http://gaia.cs.umass.edu/wireshark-labs/INTRO-wireshark-file1.html>

---

9. 查找从您的计算机发送到`gaia.cs.umass.edu` HTTP服务器。（在Wireshark窗口的“捕获包列表”部分中查找HTTPGET消息（参见图3和图5），该消息显示“GET”后跟`gaia.cs.umass.edu`您输入的URL。当您选择HTTP `GET`消息时，以太网帧、IP数据报、TCP段和HTTP消息头信息将显示在包头窗口中。通过单击“+”和“-”以及数据包详细信息窗口左侧的右箭头和下箭头，*最小化*显示的帧、以太网、Internet协议和传输控制协议信息的数量。*最大化*显示的关于HTTP协议的信息量。Wireshark的显示现在应该大致如图5所示。（请特别注意，除HTTP之外的所有协议的协议信息量最小化，以及包头窗口中HTTP协议信息量的最大化）。

10. 退出Wireshark

祝贺你！你现在已经完成了第一个实验！

第一个实验室的目标主要是向你介绍Wireshark。下面的问题将证明您已经能够启动并运行Wireshark，并且已经探索了它的一些功能。根据你的Wireshark实验回答以下问题：

1. 在上面第7步的“未过滤数据包列表”窗口的“协议”列中列出3种不同的协议。

TLS、TCP、DNS

2. 从发送HTTP GET消息到收到HTTP OK回复需要多长时间？（默认情况下，包列表窗口中事件列的值是自Wireshark跟踪开始以来的时间量（以秒为单位）。要以一天中的时间格式显示时间字段，请选择Wireshark*查看*下拉菜单，然后选择时间*显示格式*，然后选择*一天中的时间*）

0.1s

3. `gaia.cs.umass.edu`的网络地址是什么（也称为`www.net.cs.umass.edu`）？你的计算机的因特网地址是什么？

128.119.245.12；192.168.0.15

4. 打印上面问题2中提到的两条HTTP消息（GET和OK）。为此，请从Wireshark*文件*命令菜单中选择*打印*，然后选择“*仅选定数据包”*和*“按显示打印”*单选按钮，然后单击“确定”。
